name: ğŸ¤– Build & Release AI Prompt Generator PowerToys Plugin

on:
    push:
        branches:
            - master
        tags:
            - "v*"

env:
    PLUGIN_DIR: AIPromptGenerator/Community.PowerToys.Run.Plugin.AIPromptGenerator
    ARTIFACT_PREFIX: AIPromptGenerator

permissions:
    contents: write
    issues: read
    pull-requests: read

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        runs-on: windows-latest
        strategy:
            matrix:
                platform: [x64, ARM64]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Cache NuGet packages
              uses: actions/cache@v4
              with:
                  path: ~/.nuget/packages
                  key: ${{ runner.os }}-nuget-${{ hashFiles('AIPromptGenerator/**/*.csproj') }}
                  restore-keys: ${{ runner.os }}-nuget-

            - name: Setup .NET
              uses: actions/setup-dotnet@v4
              with:
                  dotnet-version: "9.0.x"

            - name: Get version
              id: get_version
              shell: bash
              run: |
                  if [[ $GITHUB_REF == refs/tags/v* ]]; then
                    echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
                    echo "IS_TAG=true" >> $GITHUB_OUTPUT
                  else
                    echo "VERSION=$(date +'%Y.%m.%d')-$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_OUTPUT
                    echo "IS_TAG=false" >> $GITHUB_OUTPUT
                  fi

            - name: ğŸš€ Build & stage plugin
              shell: pwsh
              run: |
                  # 1. Inject version
                  $pluginJson = "${{ env.PLUGIN_DIR }}/plugin.json"
                  $content    = Get-Content $pluginJson -Raw | ConvertFrom-Json
                  $content.Version = "${{ steps.get_version.outputs.VERSION }}"
                  $content | ConvertTo-Json -Depth 10 | Set-Content $pluginJson -Encoding UTF8

                  # 2. Build
                  dotnet build "${{ env.PLUGIN_DIR }}/Community.PowerToys.Run.Plugin.AIPromptGenerator.csproj" `
                    -c Release `
                    -p:Platform="${{ matrix.platform }}"

                  # 3. Locate binaries
                  $outDir = "${{ env.PLUGIN_DIR }}/bin/${{ matrix.platform }}/Release"
                  $netDir = Get-ChildItem $outDir -Directory -Filter "net*-windows*" |
                            Select-Object -First 1 -ExpandProperty FullName
                  if (-not $netDir) { throw "Build output not found" }

                  # 4. Stage folder
                  $stage = "artifacts/${{ env.ARTIFACT_PREFIX }}-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform }}/${{ env.ARTIFACT_PREFIX }}"
                  New-Item $stage -ItemType Directory -Force | Out-Null

                  # 5. Copy files
                  Copy-Item "$netDir/*" $stage -Recurse -Exclude @(
                    "PowerToys*.dll","PowerToys*.pdb","Wox*.dll","Wox*.pdb"
                  )
                  Copy-Item $pluginJson $stage
                  Copy-Item "${{ env.PLUGIN_DIR }}/Images" $stage -Recurse -ErrorAction SilentlyContinue

            - name: ğŸ“¦ Zip & upload artifact
              shell: pwsh
              run: |
                  $zip = "artifacts/${{ env.ARTIFACT_PREFIX }}-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform }}.zip"
                  $src = "artifacts/${{ env.ARTIFACT_PREFIX }}-${{ steps.get_version.outputs.VERSION }}-${{ matrix.platform }}/${{ env.ARTIFACT_PREFIX }}"
                  Compress-Archive -Path $src -DestinationPath $zip

            - uses: actions/upload-artifact@v4
              with:
                  name: build-artifacts-${{ matrix.platform }}
                  path: artifacts/*.zip

    release:
        needs: build
        runs-on: ubuntu-latest
        if: startsWith(github.ref, 'refs/tags/v')

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Get version from tag
              id: get_version
              run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

            - name: Download all artifacts
              uses: actions/download-artifact@v4
              with:
                  path: downloaded-artifacts

            - name: Prepare artifacts for release
              run: |
                  mkdir -p release-artifacts
                  VERSION="${{ steps.get_version.outputs.VERSION }}"
                  cp downloaded-artifacts/build-artifacts-x64/${{ env.ARTIFACT_PREFIX }}-${VERSION}-x64.zip release-artifacts/
                  cp downloaded-artifacts/build-artifacts-ARM64/${{ env.ARTIFACT_PREFIX }}-${VERSION}-ARM64.zip release-artifacts/

            - name: Prepare release notes
              id: release_notes
              run: |
                  VERSION="${{ steps.get_version.outputs.VERSION }}"
                  cat > release_notes.md << EOL
                  # ğŸ¤– AI Prompt Generator v${VERSION} â€“ Transform Your Prompts Instantly!
                  <p align="center">
                    <img src="https://github.com/ruslanlap/PowerToysRun-AIPromptGenerator/raw/main/assets/logo.png" width="128" alt="AI Prompt Generator Logo"/>
                  </p>

                  ## âœ¨ What's New
                  - ğŸ§  **AI-Powered Prompt Expansion** (short ideas â†’ detailed prompts)
                  - ğŸŒ **Multi-Provider Support** (OpenAI, Groq, OpenRouter, HuggingFace, SambaNova)
                  - âš¡ **Lightning Fast** (integrated into PowerToys Run)
                  - ğŸ’¾ **Smart Caching** (reduces API calls and costs)
                  - ğŸ¨ **Customizable Settings** (temperature, tokens, timeouts, system prompts)
                  - ğŸ”’ **Secure Storage** (API keys encrypted in Windows settings)
                  - ğŸ“‹ **Auto-Copy** (results instantly copied to clipboard)
                  - ğŸŒ“ **Theme Support** (automatic light/dark mode icons)

                  ## ğŸš€ Install
                  1. Download ZIP for your architecture (x64 / ARM64)
                  2. Extract to \`%LOCALAPPDATA%\Microsoft\PowerToys\PowerToys Run\Plugins\AIPromptGenerator\`
                  3. Restart PowerToys
                  4. Configure your API key in PowerToys Settings â†’ PowerToys Run â†’ AI Prompt Generator
                  5. Press \`Alt+Space\` â†’ type \`aipromptgenerator <your idea>\`

                  ## ğŸ’¡ Quick Examples
                  | Input | Output |
                  |-------|--------|
                  | \`write a blog post\` | Comprehensive blog post prompt with structure, tone, and guidelines |
                  | \`create a REST API\` | Detailed API design prompt with architecture and best practices |
                  | \`analyze sales data\` | Complete data analysis prompt with methods and visualization |
                  | \`story about time travel\` | Creative writing prompt with plot structure and themes |

                  ## ğŸ¤– Supported AI Providers
                  - **OpenAI** (GPT-4o, GPT-4o-mini) - High quality, reliable
                  - **Groq** (Llama 3.3) - Ultra-fast, cost-effective
                  - **OpenRouter** - Multi-model gateway
                  - **HuggingFace** - Open-source models
                  - **SambaNova** - Enterprise inference

                  ## ğŸ”§ Configuration Options
                  - **Provider Selection** - Choose your preferred AI service
                  - **Custom Models** - Override default model per provider
                  - **Temperature Control** - Adjust creativity (0.0-2.0)
                  - **Token Limits** - Set max response length (100-4000)
                  - **System Prompts** - Define custom expansion instructions
                  - **Caching** - Enable/disable response caching (1-60 min)
                  - **Timeouts** - Configure request timeout (5-120s)

                  ## ğŸ“š Documentation
                  Full documentation available in the [README](https://github.com/ruslanlap/PowerToysRun-AIPromptGenerator#readme)

                  ## ğŸ’« Contribute
                  Found a bug or have an idea? [Open an issue](https://github.com/ruslanlap/PowerToysRun-AIPromptGenerator/issues)

                  Made with â¤ï¸ by [ruslanlap](https://github.com/ruslanlap)
                  EOL
                  echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
                  cat release_notes.md >> $GITHUB_OUTPUT
                  echo "EOF" >> $GITHUB_OUTPUT

            - name: Generate SHA256 checksums
              run: |
                  cd release-artifacts
                  VERSION="${{ steps.get_version.outputs.VERSION }}"
                  for f in *.zip; do
                    sha256sum "$f" | tee "$f.sha256"
                  done
                  {
                    echo "SHA256 Checksums for AI Prompt Generator v${VERSION}"
                    echo "Generated on: $(date -u)"
                    echo
                    cat *.sha256
                  } > checksums.txt

            - name: Create Release
              uses: softprops/action-gh-release@v1
              with:
                  name: AI Prompt Generator v${{ steps.get_version.outputs.VERSION }}
                  body: ${{ steps.release_notes.outputs.RELEASE_NOTES }}
                  draft: false
                  prerelease: false
                  files: |
                      release-artifacts/${{ env.ARTIFACT_PREFIX }}-${{ steps.get_version.outputs.VERSION }}-x64.zip
                      release-artifacts/${{ env.ARTIFACT_PREFIX }}-${{ steps.get_version.outputs.VERSION }}-ARM64.zip
                      release-artifacts/*.sha256
                      release-artifacts/checksums.txt
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
